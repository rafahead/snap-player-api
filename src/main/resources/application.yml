spring:
  application:
    name: snap-player-api
  datasource:
    url: jdbc:h2:file:./.data/snapplayerapi;MODE=PostgreSQL;DATABASE_TO_LOWER=TRUE;DEFAULT_NULL_ORDERING=HIGH
    username: sa
    password:
    driver-class-name: org.h2.Driver
  jpa:
    hibernate:
      ddl-auto: validate
    open-in-view: false
  flyway:
    enabled: true

management:
  endpoints:
    web:
      # Entrega 4 / Slice 8: expose only the minimum operational endpoints by default.
      exposure:
        include: health,metrics
  endpoint:
    health:
      # Useful for docker health checks and later readiness/liveness probing.
      probes:
        enabled: true

app:
  storage:
    local:
      # Entrega 5: default dev fallback keeps files in local persistent storage instead of temp dirs.
      enabled: true
      basePath: ./.data/storage
      # Optional; when set, paths returned in API payloads become public URLs built from this base.
      publicBaseUrl:
    s3:
      # Enable in production (Linode Object Storage / S3 compatible). When true, local storage is bypassed.
      enabled: false
      endpoint: ${STORAGE_ENDPOINT:}
      region: ${STORAGE_REGION:us-east-1}
      bucket: ${STORAGE_BUCKET:}
      accessKey: ${STORAGE_ACCESS_KEY:}
      secretKey: ${STORAGE_SECRET_KEY:}
      publicBaseUrl: ${STORAGE_PUBLIC_BASE_URL:}
      prefix: ${STORAGE_PREFIX:}

  internal:
    # Optional static token that guards all /internal/** routes.
    # When blank (default), the endpoints are open — suitable for dev or when access is restricted
    # at the network/nginx level. In production, set via environment variable.
    accessToken:
  processing:
    # Default local temp storage for synchronous frame extraction/clip generation.
    # Using a workspace-relative path keeps local dev/smoke runs functional without requiring a
    # pre-mounted `/data` volume. Production can override via environment/config.
    tmpBase: ./.data/tmp/video-frames-processing
    maxBatchItems: 10
    maxSubjectAttributes: 100
    maxDurationSeconds: 5
    maxFps: 10
    maxWidth: 1280
    acceptedContainers:
      - mp4
      - mov
      - mkv
      - webm
    ffmpeg:
      path: ffmpeg
      timeoutSeconds: 60
      fontFile: /usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf
    ffprobe:
      path: ffprobe
      timeoutSeconds: 30
  snap:
    defaultAssinaturaCodigo: default
    defaultTemplateSlug: default
    # Entrega 3 (step 2): token auth path prepared but disabled by default.
    # When enabled, private `/v2/*` routes require header `X-Assinatura-Token` matching
    # `assinatura.api_token` of the resolved tenant.
    requireApiToken: false
    # Optional absolute base URL used by `POST /v2/snaps/{id}/share`.
    # When omitted, the API returns a relative `publicUrl` (e.g. `/public/snaps/{token}`).
    publicBaseUrl:
    # Entrega 4 (Slice 6): async é o padrão em produção. Usar asyncCreateEnabled=false para preservar
    # comportamento síncrono das Entregas 1-3 (necessário nos testes de integração sync via @TestPropertySource).
    asyncCreateEnabled: true
    # Local polling worker for `snap_processing_job` (DB queue). Safe to leave enabled when
    # `asyncCreateEnabled=false` because no jobs will be enqueued by `POST /v2/snaps`.
    workerEnabled: true
    workerPollDelayMs: 1000
    workerBatchSize: 1
    workerMaxAttempts: 3
    workerRetryDelaySeconds: 10
    workerRetryBackoffMultiplier: 2.0
    workerRetryMaxDelaySeconds: 300
    # Operational constraint: lockTimeout must be > heartbeatInterval * 3.
    # With defaults (heartbeat=30s, lockTimeout=120s), a crashed worker is recovered
    # within 120s of its last heartbeat — providing 4 heartbeat windows before recovery.
    workerLockTimeoutSeconds: 120
    # Heartbeat interval for renewing locked_at on active RUNNING jobs (ms).
    # Keep below workerLockTimeoutSeconds * 1000 / 3 (default: 30000 < 120000/3 = 40000).
    workerHeartbeatIntervalMs: 30000
    # Identifier of this worker instance in claimed_by / lock_owner.
    # ${HOSTNAME} resolves to the container ID in Docker, uniquely identifying the worker.
    # Falls back to "local-worker" when HOSTNAME is not set (bare-metal dev).
    workerInstanceId: ${HOSTNAME:local-worker}
    jobCleanupEnabled: true
    jobCleanupDelayMs: 60000
    jobRetentionHours: 168
    jobCleanupBatchSize: 100
