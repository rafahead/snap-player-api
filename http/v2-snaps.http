### Snap Player API - v2 Snaps (privado)
### ---------------------------------------------------------------------------
### Este arquivo cobre o fluxo principal da API v2 Snap-first:
### - criar snap
### - buscar snap por id
### - listar snaps por vídeo
### - buscar por subject/atributo
### - listar "mine" (snaps e vídeos)
###
### Configuração de headers:
### - `X-Assinatura-Codigo` é opcional (fallback = `default`)
### - `X-Assinatura-Token` só é obrigatório quando `app.snap.requireApiToken=true`
###
### Dica de uso:
### 1) Rode "POST Create Snap (videoUrl)"
### 2) O script pós-resposta salva `lastSnapId` e `lastVideoId` automaticamente (global)
### 3) Rode as consultas/listagens na sequência usando os IDs capturados
### 4) Se quiser forçar manualmente, substitua `{{lastSnapId}}` / `{{lastVideoId}}` nos requests
###
### Modo assíncrono (padrão desde Slice 6 / Entrega 4):
### - `POST /v2/snaps` retorna `202 Accepted` com `status=PENDING` imediatamente
### - `SnapResponse` (create/get by id) inclui campo `job` com estado da fila/worker
### - Use `GET /v2/snaps/{snapId}` como polling até `status=COMPLETED` ou `FAILED`
### - O worker local (polling DB) usa `app.snap.worker*` e está habilitado por padrão
### - Retentativas usam backoff exponencial (`workerRetry*`), com recuperação de `RUNNING` órfão
### - Cleanup de jobs antigos usa `app.snap.jobCleanup*`
### - Para modo síncrono local use: `--app.snap.asyncCreateEnabled=false` (ou config ".run/Sync")

@baseUrl = http://127.0.0.1:8080
@assinaturaCodigo = default
@assinaturaToken = dev-default-token
@internalToken =
@nickname = rafahead

### POST Create Snap (videoUrl)
### Regra importante:
### - Se `subject.id` for omitido, a API aplica fallback para `snapId`.
POST {{baseUrl}}/v2/snaps
Content-Type: application/json
X-Assinatura-Codigo: {{assinaturaCodigo}}
X-Request-Id: v2-create-snap-001
# X-Assinatura-Token: {{assinaturaToken}}

{
  "videoUrl": "https://appimagens.br-gru-1.linodeobjects.com/57_36081920_20250220T170651_9eb0.mp4",
  "nickname": "{{nickname}}",
  "email": "{{nickname}}@example.com",
  "dataFilmagem": "2026-02-24T14:30:00-03:00",
  "startFrame": 360,
  "durationSeconds": 1.0,
  "snapshotDurationSeconds": 2.0,
  "fps": 5,
  "maxWidth": 640,
  "format": "jpg",
  "quality": 8,
  "subject": {
    "attributes": [
      { "key": "brinco", "type": "string", "stringValue": "HTTP-001" },
      { "key": "peso", "type": "number", "numberValue": 450.0 }
    ]
  },
  "overlay": {
    "enabled": true,
    "mode": "SUBJECT",
    "position": "TOP_RIGHT"
  }
}
> {%
  // Encadeia o fluxo manual no IntelliJ HTTP Client sem copiar/colar IDs da resposta.
  // 201 = modo síncrono (COMPLETED imediato); 202 = modo assíncrono (PENDING + job enfileirado).
  if ((response.status === 201 || response.status === 202) && response.body) {
    if (response.body.snapId) client.global.set("lastSnapId", response.body.snapId);
    if (response.body.videoId) client.global.set("lastVideoId", response.body.videoId);
    client.log("lastSnapId=" + (response.body.snapId || "<missing>"));
    client.log("lastVideoId=" + (response.body.videoId || "<missing>"));
    client.log("snap.status=" + (response.body.status || "<missing>"));
  }
%}

### GET Snap by Id
### Em modo assíncrono, repita esta chamada até o `status` sair de `PENDING`.
### Campos úteis no payload:
### - `job.status`: `PENDING` | `RUNNING` | `RETRY_WAIT` | `COMPLETED` | `FAILED`
### - `job.attempts`, `job.maxAttempts`
### - `job.nextRunAt` (quando houver retry agendado)
### - `job.lastError` (falha atual/última falha)
GET {{baseUrl}}/v2/snaps/{{lastSnapId}}
X-Assinatura-Codigo: {{assinaturaCodigo}}
X-Request-Id: v2-get-snap-001
# X-Assinatura-Token: {{assinaturaToken}}

### GET Snap by Id (polling async - exemplo)
GET {{baseUrl}}/v2/snaps/{{lastSnapId}}
X-Assinatura-Codigo: {{assinaturaCodigo}}
X-Request-Id: v2-get-snap-poll-001
# X-Assinatura-Token: {{assinaturaToken}}

### GET Snaps by Video (paginação/ordenação padrão Entrega 3)
GET {{baseUrl}}/v2/videos/{{lastVideoId}}/snaps?offset=0&limit=20&sortBy=resolvedStartSeconds&sortDir=asc
X-Assinatura-Codigo: {{assinaturaCodigo}}
X-Request-Id: v2-list-video-snaps-001
# X-Assinatura-Token: {{assinaturaToken}}

### GET Snaps by Video (filtro por nickname)
GET {{baseUrl}}/v2/videos/{{lastVideoId}}/snaps?nickname={{nickname}}&offset=0&limit=20&sortBy=createdAt&sortDir=desc
X-Assinatura-Codigo: {{assinaturaCodigo}}
X-Request-Id: v2-list-video-snaps-nickname-001
# X-Assinatura-Token: {{assinaturaToken}}

### GET Search by subjectId
GET {{baseUrl}}/v2/snaps/search?subjectId=animal-123&offset=0&limit=20&sortBy=createdAt&sortDir=desc
X-Assinatura-Codigo: {{assinaturaCodigo}}
X-Request-Id: v2-search-subject-001
# X-Assinatura-Token: {{assinaturaToken}}

### GET Search by attribute (string equality)
GET {{baseUrl}}/v2/snaps/search?attrKey=brinco&attrValue=HTTP-001&offset=0&limit=20&sortBy=createdAt&sortDir=desc
X-Assinatura-Codigo: {{assinaturaCodigo}}
X-Request-Id: v2-search-attr-001
# X-Assinatura-Token: {{assinaturaToken}}

### GET My Snaps (nickname temporário; Entrega 2/3)
GET {{baseUrl}}/v2/snaps/mine?nickname={{nickname}}&offset=0&limit=20&sortBy=createdAt&sortDir=desc
X-Assinatura-Codigo: {{assinaturaCodigo}}
X-Request-Id: v2-mine-snaps-001
# X-Assinatura-Token: {{assinaturaToken}}

### GET My Videos (agregado por vídeo, ordenado por atividade mais recente)
GET {{baseUrl}}/v2/videos/mine?nickname={{nickname}}&offset=0&limit=20&sortBy=latestSnapCreatedAt&sortDir=desc
X-Assinatura-Codigo: {{assinaturaCodigo}}
X-Request-Id: v2-mine-videos-001
# X-Assinatura-Token: {{assinaturaToken}}

### GET My Videos (ordenar por snapCount)
GET {{baseUrl}}/v2/videos/mine?nickname={{nickname}}&offset=0&limit=20&sortBy=snapCount&sortDir=desc
X-Assinatura-Codigo: {{assinaturaCodigo}}
X-Request-Id: v2-mine-videos-by-count-001
# X-Assinatura-Token: {{assinaturaToken}}

### GET Search (exemplo de erro de validação - attrKey sem attrValue)
GET {{baseUrl}}/v2/snaps/search?attrKey=brinco
X-Assinatura-Codigo: {{assinaturaCodigo}}
X-Request-Id: v2-search-invalid-001
# X-Assinatura-Token: {{assinaturaToken}}